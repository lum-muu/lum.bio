# GitLab CI/CD Configuration for Lum.bio Portfolio
# Mirrors GitHub Actions workflow for consistency

# Define stages
stages:
  - quality
  - security
  - build

# Use Node.js 20 Docker image
image: node:20

# Global cache configuration for faster builds
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull

# Shared installation template
.install-deps:
  before_script:
    - npm ci
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull-push

# Quality check jobs run in parallel
lint:
  extends: .install-deps
  stage: quality
  script:
    - npm run lint
  only:
    - main
    - develop
    - merge_requests

format-check:
  extends: .install-deps
  stage: quality
  script:
    - npm run format:check
  only:
    - main
    - develop
    - merge_requests

type-check:
  extends: .install-deps
  stage: quality
  script:
    - npm run type-check
  only:
    - main
    - develop
    - merge_requests

test:
  extends: .install-deps
  stage: quality
  variables:
    VITE_CONTACT_ENDPOINT: https://example.com/contact
  script:
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
    when: always
  only:
    - main
    - develop
    - merge_requests

# Content integrity verification
integrity-check:
  extends: .install-deps
  stage: quality
  script:
    - npm run integrity:check
  only:
    - main
    - develop
    - merge_requests

# E2E tests with Playwright
e2e-test:
  stage: quality
  image: mcr.microsoft.com/playwright:v1.56.1-jammy
  variables:
    VITE_CONTACT_ENDPOINT: /api/contact
    VITE_CONTACT_TIMEOUT: "10000"
  before_script:
    - npm ci
    - npx playwright install --with-deps chromium
  script:
    - npm run test:e2e
  artifacts:
    when: always
    paths:
      - playwright-report/
      - test-results/
    expire_in: 7 days
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull-push
  only:
    - main
    - develop
    - merge_requests

# Security scanning
security-scan:
  extends: .install-deps
  stage: security
  script:
    - npm run ci:security
  only:
    - main
    - develop
    - merge_requests

# License compliance check
license-check:
  extends: .install-deps
  stage: security
  script:
    - npm run ci:license
  artifacts:
    when: always
    paths:
      - coverage/licenses.csv
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests

# Dependency health check (non-blocking)
deps-check:
  extends: .install-deps
  stage: security
  script:
    - npm run ci:deps
  artifacts:
    when: always
    paths:
      - coverage/npm-outdated.json
    expire_in: 7 days
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# Build job runs after all checks pass
build:
  extends: .install-deps
  stage: build
  variables:
    VITE_CONTACT_ENDPOINT: https://example.com/contact
  script:
    - npm run build
    - echo "## Build Size Report"
    - du -sh dist/
    - echo "Largest JS files:"
    - find dist/ -type f -name "*.js" -exec du -h {} \; | sort -rh | head -10
  artifacts:
    paths:
      - dist/
    expire_in: 7 days
  needs:
    - job: lint
    - job: format-check
    - job: type-check
    - job: test
    - job: integrity-check
    - job: e2e-test
    - job: security-scan
    - job: license-check
    # deps-check is allow_failure, so not included in needs
  only:
    - main
    - develop
    - merge_requests
