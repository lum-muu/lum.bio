# GitLab CI/CD Configuration for Lum.bio Portfolio
# Mirrors GitHub Actions workflow for consistency

# Define stages
stages:
  - quality
  - security
  - build

# Use Node.js 20 Docker image
image: node:20

# Global cache configuration for faster builds
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull

# Shared installation template
.install-deps:
  before_script:
    - npm ci
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
    policy: pull-push

# Quality check jobs run in parallel
lint:
  extends: .install-deps
  stage: quality
  script:
    - npm run lint
  only:
    - main
    - develop
    - merge_requests

format-check:
  extends: .install-deps
  stage: quality
  script:
    - npm run format:check
  only:
    - main
    - develop
    - merge_requests

type-check:
  extends: .install-deps
  stage: quality
  script:
    - npm run type-check
  only:
    - main
    - develop
    - merge_requests

test:
  extends: .install-deps
  stage: quality
  variables:
    VITE_EMAILJS_SERVICE_ID: $VITE_EMAILJS_SERVICE_ID
    VITE_EMAILJS_TEMPLATE_ID: $VITE_EMAILJS_TEMPLATE_ID
    VITE_EMAILJS_PUBLIC_KEY: $VITE_EMAILJS_PUBLIC_KEY
  script:
    - npm run test:coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
    when: always
  only:
    - main
    - develop
    - merge_requests

# Security scanning
security-scan:
  extends: .install-deps
  stage: security
  script:
    - npm run ci:security
  only:
    - main
    - develop
    - merge_requests

# Build job runs after all checks pass
build:
  extends: .install-deps
  stage: build
  variables:
    VITE_EMAILJS_SERVICE_ID: $VITE_EMAILJS_SERVICE_ID
    VITE_EMAILJS_TEMPLATE_ID: $VITE_EMAILJS_TEMPLATE_ID
    VITE_EMAILJS_PUBLIC_KEY: $VITE_EMAILJS_PUBLIC_KEY
  script:
    - npm run build
    - echo "## Build Size Report"
    - du -sh dist/
    - echo "Largest JS files:"
    - find dist/ -type f -name "*.js" -exec du -h {} \; | sort -rh | head -10
  artifacts:
    paths:
      - dist/
    expire_in: 7 days
  needs:
    - lint
    - format-check
    - type-check
    - test
    - security-scan
  only:
    - main
    - develop
    - merge_requests
