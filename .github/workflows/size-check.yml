name: Bundle Size Check

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  size-check:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    env:
      VITE_EMAILJS_SERVICE_ID: ${{ secrets.VITE_EMAILJS_SERVICE_ID }}
      VITE_EMAILJS_TEMPLATE_ID: ${{ secrets.VITE_EMAILJS_TEMPLATE_ID }}
      VITE_EMAILJS_PUBLIC_KEY: ${{ secrets.VITE_EMAILJS_PUBLIC_KEY }}
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Install size-limit
        run: npm install --no-save size-limit @size-limit/preset-app @size-limit/file

      - name: Check bundle size
        run: npx size-limit

      - name: Save PR branch sizes
        if: github.event_name == 'pull_request'
        run: |
          # Save PR branch sizes
          npx size-limit --json > /tmp/pr-size.json || true

          # Save PR dist sizes for comparison
          du -sh dist/ > /tmp/pr-dist-size.txt
          find dist/assets -type f -name "*.js" -exec du -h {} \; | sort -rh > /tmp/pr-js-sizes.txt

      - name: Compare with main branch
        if: github.event_name == 'pull_request'
        run: |
          # Clean build artifacts and generated files
          git clean -fdx dist/ src/content/_aggregated.json

          # Checkout main branch
          git fetch origin main
          git checkout origin/main

          # Build main branch
          npm ci
          npm run build

          # Save main branch sizes
          npx size-limit --json > /tmp/main-size.json || true
          du -sh dist/ > /tmp/main-dist-size.txt
          find dist/assets -type f -name "*.js" -exec du -h {} \; | sort -rh > /tmp/main-js-sizes.txt

          echo "## Bundle Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PR Branch vs Main Branch" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "PR Branch:" >> $GITHUB_STEP_SUMMARY
          cat /tmp/pr-dist-size.txt >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Main Branch:" >> $GITHUB_STEP_SUMMARY
          cat /tmp/main-dist-size.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Report bundle analysis
        run: |
          echo "## Bundle Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### File Sizes (gzipped)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find dist/assets -type f \( -name "*.js" -o -name "*.css" \) -exec sh -c 'gzip -c "$1" | wc -c | awk "{printf \"%s: %s KB\\n\", \"$1\", \$1/1024}"' _ {} \; >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
